<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>esnet-smartnic-hw - esnet-smartnic-tutorial</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atelier-dune-light.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">esnet-smartnic-tutorial</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">Home</a>
                            </li>
                            <li class="navitem">
                                <a href="../1-lesson1/" class="nav-link">Getting Started</a>
                            </li>
                            <li class="navitem active">
                                <a href="./" class="nav-link">esnet-smartnic-hw</a>
                            </li>
                            <li class="navitem">
                                <a href="../3-lesson3/" class="nav-link">P4 Simulation</a>
                            </li>
                            <li class="navitem">
                                <a href="../4-lesson4/" class="nav-link">RTL Simulation</a>
                            </li>
                            <li class="navitem">
                                <a href="../5-lesson5/" class="nav-link">The ESnet Stack</a>
                            </li>
                            <li class="navitem">
                                <a href="../6-lesson6/" class="nav-link">esnet-smartnic-fw</a>
                            </li>
                            <li class="navitem">
                                <a href="../7-lesson7/" class="nav-link">DPDK</a>
                            </li>
                            <li class="navitem">
                                <a href="../z-appendix_a/" class="nav-link">Operator's Guide</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../1-lesson1/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../3-lesson3/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#using-xilinx-alveo-fpgas-as-smartnics-with-esnet-framework" class="nav-link">Using Xilinx Alveo FPGAs as SmartNICs with ESnet Framework</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#lesson-2-esnet-smartnic-hw" class="nav-link">Lesson 2: esnet-smartnic-hw</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#lesson-3-p4-simulation" class="nav-link">Lesson 3: P4 Simulation</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="using-xilinx-alveo-fpgas-as-smartnics-with-esnet-framework">Using Xilinx Alveo FPGAs as SmartNICs with ESnet Framework</h1>
<h2 id="lesson-2-esnet-smartnic-hw">Lesson 2: esnet-smartnic-hw</h2>
<p>This lesson builds on following the steps in Lesson 1.</p>
<h3 id="building-the-smartnic-p4_only-example-design">Building the SmartNIC p4_only Example Design</h3>
<p>Build the <code>p4_only</code> example design by executing the p4_only application Makefile.
From the esnet-smartnic-hw directory:</p>
<pre><code>   &gt; cd examples/p4_only
   &gt; make
</code></pre>
<p>Upon completion, the above step creates an artifact zipfile with the default pathname:
   <code>artifacts/&lt;BUILD_NAME&gt;/artifacts.&lt;BOARD&gt;.&lt;BUILD_NAME&gt;.0.zip</code></p>
<p>This artifact zipfile contains all of the necessary h/w artifacts to integrate with the firmware.
   In addition to the bitfile, it includes firmware driver files, regmap yaml files, the source p4 file,
   and any wireshark .lua files.</p>
<p>For more details about the <code>p4_only</code> design, as well as simulating the P4 program,  refer to
   <code>examples/p4_only/README.md</code>.</p>
<h3 id="building-a-new-p4-application">Building a New P4 Application</h3>
<p>The following steps can be taken by a new user to setup a local application design directory for building
the bitfile and artifacts for a custom P4-based SmartNIC application.</p>
<ol>
<li>Install the esnet-smartnic-hw respository (as described above).</li>
</ol>
<p>Or, alternatively, add the esnet-smartnic-hw respository to an existing git repository as a sub-module:</p>
<pre><code>   &gt; git submodule add https://github.com/esnet/esnet-smartnic-hw.git
</code></pre>
<ol>
<li>
<p>Initialize all submodules within the esnet-smartnic-hw/ design directory:</p>
<blockquote>
<p>cd esnet-smartnic-hw
git submodule update --init --recursive</p>
</blockquote>
</li>
<li>
<p>Install Vivado and configure the runtime environment (as described above).</p>
</li>
<li>
<p>Return  to the local application design directory and then copy the example SmartNIC application Makefile and p4/ sub-directory into the local application design directory:</p>
<blockquote>
<p>cd ../
cp esnet-smartnic-hw/examples/p4_only/Makefile ./
cp -r esnet-smartnic-hw/examples/p4_only/p4 ./</p>
</blockquote>
</li>
<li>
<p>Using a preferred editor, edit the copied Makefile to update the SMARTNIC_DIR environment variable assignment as follows:</p>
<p>#SMARTNIC_DIR := ../..
   SMARTNIC_DIR := $(CURDIR)/esnet-smartnic-hw</p>
</li>
<li>
<p>Copy the application p4 file to the following location and filename:</p>
<blockquote>
<p>cp <p4_filename> p4/<code>basename $PWD</code>.p4</p>
</blockquote>
<p>Note: By default, the SmartNIC scripts take the basename of the application design directory to be the name of the application, as well as its associated filenames.</p>
</li>
<li>
<p>Build the design by executing the copied application Makefile:</p>
<blockquote>
<p>make</p>
</blockquote>
</li>
<li>
<p>To simulate the P4 program, refer to the readme file provided in the p4/sim/ directory i.e. <code>p4/sim/README.md</code></p>
</li>
</ol>
<h3 id="p4-programming-requirements">P4 Programming Requirements</h3>
<p>The P4 processing core of the SmartNIC platform is implemented with the AMD (Xilinx) VitisNetP4 IP core.
In order to meet the requirements of the VitisNetP4 IP core and the SmartNIC platform, a new P4 program should
consider the following guidelines.</p>
<h4 id="amd-xilinx-p4-architecture">AMD (Xilinx) P4 Architecture:</h4>
<p>The Vitis Networking P4 compiler supports a specific pipelined datapath architecture that is comprised of 3
customizable stages: A Parser Engine, followed by a Match-Action Engine, followed by a Deparser Engine.
User P4 files <strong>MUST</strong> be structured to comply with this processing architecture, and specify the custom operations
desired within each of these processing stages.</p>
<p>More details about the AMD (Xilinx) P4 architecture can be found in the <em>Vitis Networking P4 User Guide, UG1308
(v2023.1) May 16, 2023</em>.</p>
<h4 id="include-files">Include files:</h4>
<p>The P4 program <strong>MUST</strong> include the following AMD (Xilinx) VitisNetP4 include files:</p>
<pre><code>  #include &lt;core.p4&gt;
  #include &lt;xsa.p4&gt;
</code></pre>
<p>These files capture built-in constructs and the standard definitions for the AMD (Xilinx) P4 architecture.
They are located in the Vivado installation directory at:
<code>$XILINX_VIVADO/data/ip/xilinx/vitis_net_p4_v1_1/include/p4/</code></p>
<h4 id="interfaces">Interfaces:</h4>
<p>The P4 processing core supports 3 types of interfaces:</p>
<ul>
<li>
<p><em>Packet Ports</em> are the primary interfaces responsible for moving packets in and out of the core, as well as
between engines.  Engines can only contain a single input packet port and a single output packet port.</p>
</li>
<li>
<p><em>Metadata Ports</em> carry sideband data related to a packet. Metadata can only correspond to a single packet
and is processed in parallel with the packet.  More on Metadata below.</p>
</li>
<li>
<p><em>Register IO Ports (axi4l)</em> are used to control the contents of the Look-up engines.</p>
</li>
</ul>
<h4 id="metadata-definitions">Metadata Definitions:</h4>
<p>The VitisNetP4 core supports both <code>Standard Metadata</code> (defined and set by the P4 core), and <code>User Metadata</code>
(defined and set by the SmartNIC platform).  Both types of metadata can be read and/or written by the P4
program.</p>
<p>For more details about the <code>Standard Metadata</code> definitions, see <em>Vitis Networking P4 User Guide, UG1308
(v2023.1) May 16, 2023</em>.</p>
<p>In order for the compiled VitisNetP4 core to match the SmartNIC application interface, a user P4 program <strong>MUST</strong>
define the User Metadata structure as follows:</p>
<pre><code>struct smartnic_metadata {
    bit&lt;64&gt; timestamp_ns;    // 64b timestamp (in nanoseconds). Set at packet arrival time.
    bit&lt;16&gt; pid;             // 16b packet id used by platform (READ ONLY - DO NOT EDIT).
    bit&lt;3&gt;  ingress_port;    // 3b ingress port (0:CMAC0, 1:CMAC1, 2:HOST0, 3:HOST1).
    bit&lt;3&gt;  egress_port;     // 3b egress port  (0:CMAC0, 1:CMAC1, 2:HOST0, 3:HOST1).
    bit&lt;1&gt;  truncate_enable; // reserved (tied to 0).
    bit&lt;16&gt; truncate_length; // reserved (tied to 0).
    bit&lt;1&gt;  rss_enable;      // reserved (tied to 0).
    bit&lt;12&gt; rss_entropy;     // reserved (tied to 0).
    bit&lt;4&gt;  drop_reason;     // reserved (tied to 0).
    bit&lt;32&gt; scratch;         // reserved (tied to 0).
}
</code></pre>
<h4 id="lookup-engines-and-externs">Lookup Engines and Externs:</h4>
<p>In order for the compiled VitisNetP4 core to match the SmartNIC application
interface, a user Program <strong>MUST</strong> have:</p>
<ul>
<li>One (or more) Look-up Engines.</li>
<li>No HBM BCAMs.</li>
<li>No Externs.</li>
</ul>
<p>Support for these features may be added in a future release.</p>
<h3 id="the-tldr">The tl;dr</h3>
<p>You can simply do: <code>cd examples/p4_only/p4</code> and here you can modify the p4 program. If you run <code>make</code> it will compile your P4 program into the Xilinx FPGA board model specified in <code>Makefile</code>.</p>
<p>In Lesson 3, you will learn how to simulate the behavior of your program.</p>
<h3 id="references">References</h3>
<p>This tutorial is built on the following software/respositories along with versions/commits:</p>
<ul>
<li>Ubuntu 20.04 with Linux 5.4.0-153.</li>
<li>Vivado 2023.1 with the VitisNetowrkingP4 license.</li>
<li>The <a href="https://github.com/esnet/esnet-smartnic-hw">esnet-smartnic-hw</a> repository (commit: 9ee2cbb).</li>
<li>The <a href="https://github.com/esnet/esnet-smartnic-fw">esnet-smartnic-fw</a> repository (commit: 180595c).</li>
<li>The <a href="https://github.com/esnet/smartnic-dpdk-docker">smartnic-dpdk-docker</a> repository (commit: a52dba3).</li>
<li>The <a href="https://github.com/esnet/xilinx-labtools-docker">xilinx-labtools-docker</a> repository (commit: 84cf05f).</li>
</ul>
<h3 id="known-issues">Known Issues</h3>
<p>None to date. If you face any issues, please contact <a href="mailto:https://groups.google.com/a/iit.edu/g/cs595-f2023-group">https://groups.google.com/a/iit.edu/g/cs595-f2023-group</a></p>
<h2 id="lesson-3-p4-simulation">Lesson 3: P4 Simulation</h2>
<p>Link: <strong><a href="../3-lesson3/">Lesson 3: P4 Simulation</a></strong></p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../js/jquery-3.6.0.min.js"></script>
        <script src="../js/bootstrap.min.js"></script>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js"></script>
        <script src="../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
